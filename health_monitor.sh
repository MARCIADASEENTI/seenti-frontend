#!/bin/bash
# health_monitor.sh - Sistema de monitoramento cont√≠nuo
# Sprint 08 - Sistema de Monitoramento

# Configura√ß√µes
MONITOR_LOG="health_monitor.log"
ALERT_LOG="alerts.log"
CONFIG_FILE="monitor.config"
CHECK_INTERVAL=300  # 5 minutos
MAX_FAILURES=3
ALERT_EMAIL="admin@seenti.com.br"
ALERT_SLACK_WEBHOOK=""

# Cores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Fun√ß√£o para log com timestamp
log() {
    local message="[$(date +'%Y-%m-%d %H:%M:%S')] $1"
    echo -e "${GREEN}$message${NC}"
    echo "$message" >> "$MONITOR_LOG"
}

warn() {
    local message="[$(date +'%Y-%m-%d %H:%M:%S')] WARNING: $1"
    echo -e "${YELLOW}$message${NC}"
    echo "$message" >> "$MONITOR_LOG"
}

error() {
    local message="[$(date +'%Y-%m-%d %H:%M:%S')] ERROR: $1"
    echo -e "${RED}$message${NC}"
    echo "$message" >> "$MONITOR_LOG"
}

success() {
    local message="[$(date +'%Y-%m-%d %H:%M:%S')] SUCCESS: $1"
    echo -e "${CYAN}$message${NC}"
    echo "$message" >> "$MONITOR_LOG"
}

info() {
    local message="[$(date +'%Y-%m-%d %H:%M:%S')] INFO: $1"
    echo -e "${BLUE}$message${NC}"
    echo "$message" >> "$MONITOR_LOG"
}

# Fun√ß√£o para carregar configura√ß√£o
load_config() {
    if [ -f "$CONFIG_FILE" ]; then
        source "$CONFIG_FILE"
        success "‚úÖ Configura√ß√£o carregada: $CONFIG_FILE"
    else
        warn "‚ö†Ô∏è  Arquivo de configura√ß√£o n√£o encontrado, usando padr√µes"
        create_default_config
    fi
}

# Fun√ß√£o para criar configura√ß√£o padr√£o
create_default_config() {
    cat > "$CONFIG_FILE" << 'EOF'
# Configura√ß√£o de Monitoramento - Seenti App
# Sprint 08 - Sistema de Monitoramento

# Configura√ß√µes de Health Check
CHECK_INTERVAL=300
MAX_FAILURES=3
ENABLE_EMAIL_ALERTS=true
ENABLE_SLACK_ALERTS=false

# URLs para monitoramento
FRONTEND_URL="https://frontend-seenti-app.vercel.app"
BACKEND_URL="https://backend-seenti-app.onrender.com"
MONGODB_URL="mongodb+srv://App_mdb:nJkn86jYvUjlwpJ@ps-terapia.8dgyy1d.mongodb.net/seenti_db"

# Configura√ß√µes de alerta
ALERT_EMAIL="admin@seenti.com.br"
ALERT_SLACK_WEBHOOK=""

# Thresholds de performance
RESPONSE_TIME_THRESHOLD=5000  # 5 segundos
MEMORY_THRESHOLD=80           # 80%
DISK_THRESHOLD=90             # 90%

# Configura√ß√µes de log
LOG_RETENTION_DAYS=30
LOG_LEVEL="INFO"
EOF
    success "‚úÖ Configura√ß√£o padr√£o criada: $CONFIG_FILE"
}

# Fun√ß√£o para health check do frontend
check_frontend_health() {
    local url="${FRONTEND_URL:-https://frontend-seenti-app.vercel.app}"
    local start_time=$(date +%s%N)
    
    local http_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "$url" 2>/dev/null || echo "000")
    local end_time=$(date +%s%N)
    local response_time=$(( (end_time - start_time) / 1000000 ))
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "301" ] || [ "$http_code" = "302" ]; then
        if [ $response_time -lt ${RESPONSE_TIME_THRESHOLD:-5000} ]; then
            success "üé® Frontend: Online (HTTP $http_code, ${response_time}ms)"
            return 0
        else
            warn "üé® Frontend: Lento (HTTP $http_code, ${response_time}ms)"
            return 1
        fi
    else
        error "üé® Frontend: Offline (HTTP $http_code)"
        return 1
    fi
}

# Fun√ß√£o para health check do backend
check_backend_health() {
    local url="${BACKEND_URL:-https://backend-seenti-app.onrender.com}"
    local start_time=$(date +%s%N)
    
    local http_code=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "$url" 2>/dev/null || echo "000")
    local end_time=$(date +%s%N)
    local response_time=$(( (end_time - start_time) / 1000000 ))
    
    if [ "$http_code" = "200" ] || [ "$http_code" = "301" ] || [ "$http_code" = "302" ]; then
        if [ $response_time -lt ${RESPONSE_TIME_THRESHOLD:-5000} ]; then
            success "üîß Backend: Online (HTTP $http_code, ${response_time}ms)"
            return 0
        else
            warn "üîß Backend: Lento (HTTP $http_code, ${response_time}ms)"
            return 1
        fi
    else
        error "üîß Backend: Offline (HTTP $http_code)"
        return 1
    fi
}

# Fun√ß√£o para health check do banco de dados
check_database_health() {
    local url="${MONGODB_URL:-mongodb+srv://App_mdb:nJkn86jYvUjlwpJ@ps-terapia.8dgyy1d.mongodb.net/seenti_db}"
    
    if command -v mongosh &> /dev/null; then
        if timeout 10 mongosh "$url" --eval "db.runCommand('ping')" &> /dev/null; then
            success "üóÑÔ∏è  MongoDB: Conectividade OK"
            return 0
        else
            error "üóÑÔ∏è  MongoDB: Falha na conex√£o"
            return 1
        fi
    else
        warn "üóÑÔ∏è  mongosh n√£o dispon√≠vel para teste de MongoDB"
        return 0  # N√£o falha se a ferramenta n√£o estiver dispon√≠vel
    fi
}

# Fun√ß√£o para verificar recursos do sistema
check_system_resources() {
    log "üíª Verificando recursos do sistema..."
    
    # Verificar espa√ßo em disco
    local disk_usage=$(df -h . | tail -1 | awk '{print $5}' | sed 's/%//')
    local disk_available=$(df -h . | tail -1 | awk '{print $4}')
    
    if [ "$disk_usage" -lt "${DISK_THRESHOLD:-90}" ]; then
        success "   üíæ Disco: $disk_usage% usado, $disk_available dispon√≠vel"
    else
        warn "   üíæ Disco: $disk_usage% usado, $disk_available dispon√≠vel (CR√çTICO)"
        return 1
    fi
    
    # Verificar mem√≥ria
    if command -v free &> /dev/null; then
        local memory_total=$(free -m | grep Mem | awk '{print $2}')
        local memory_used=$(free -m | grep Mem | awk '{print $3}')
        local memory_percent=$(( memory_used * 100 / memory_total ))
        
        if [ "$memory_percent" -lt "${MEMORY_THRESHOLD:-80}" ]; then
            success "   üß† Mem√≥ria: $memory_percent% usado (${memory_used}MB/${memory_total}MB)"
        else
            warn "   üß† Mem√≥ria: $memory_percent% usado (${memory_used}MB/${memory_total}MB) (ALTO)"
            return 1
        fi
    fi
    
    # Verificar processos
    local backend_processes=$(pgrep -f "python3 app.py" | wc -l)
    local frontend_processes=$(pgrep -f "vite" | wc -l)
    
    if [ "$backend_processes" -gt 0 ]; then
        success "   üîß Backend: $backend_processes processo(s) rodando"
    else
        warn "   üîß Backend: Nenhum processo rodando"
    fi
    
    if [ "$frontend_processes" -gt 0 ]; then
        success "   üé® Frontend: $frontend_processes processo(s) rodando"
    else
        warn "   üé® Frontend: Nenhum processo rodando"
    fi
    
    return 0
}

# Fun√ß√£o para verificar funcionalidades cr√≠ticas
check_critical_functionality() {
    log "üß™ Verificando funcionalidades cr√≠ticas..."
    
    local critical_checks=0
    local total_checks=0
    
    # 1. Verificar se o backend pode ser importado
    if [ -f "SeentiCliente/dev/app.py" ]; then
        ((total_checks++))
        if python3 -c "import sys; sys.path.append('SeentiCliente/dev'); import app" 2>/dev/null; then
            success "   ‚úÖ Backend: Importa√ß√£o OK"
            ((critical_checks++))
        else
            error "   ‚ùå Backend: Falha na importa√ß√£o"
        fi
    fi
    
    # 2. Verificar se h√° arquivos cr√≠ticos
    local critical_files=(
        "SeentiCliente/dev/app.py"
        "SeentiCliente/Frontend/src/App.jsx"
        ".env"
        "SeentiCliente/requirements.txt"
        "SeentiCliente/Frontend/package.json"
    )
    
    for file in "${critical_files[@]}"; do
        ((total_checks++))
        if [ -f "$file" ]; then
            success "   ‚úÖ $file: Presente"
            ((critical_checks++))
        else
            error "   ‚ùå $file: Ausente"
        fi
    done
    
    # Calcular percentual de sucesso
    local success_rate=$(( critical_checks * 100 / total_checks ))
    
    if [ $success_rate -ge 80 ]; then
        success "   üéØ Funcionalidades cr√≠ticas: $success_rate% OK"
        return 0
    else
        warn "   ‚ö†Ô∏è  Funcionalidades cr√≠ticas: $success_rate% OK"
        return 1
    fi
}

# Fun√ß√£o para enviar alertas
send_alert() {
    local alert_type="$1"
    local message="$2"
    local timestamp=$(date +'%Y-%m-%d %H:%M:%S')
    
    # Log do alerta
    echo "[$timestamp] $alert_type: $message" >> "$ALERT_LOG"
    
    # Alerta por email (se configurado)
    if [ "${ENABLE_EMAIL_ALERTS:-true}" = "true" ] && command -v mail &> /dev/null; then
        echo "$message" | mail -s "ALERTA SEENTI: $alert_type" "$ALERT_EMAIL" 2>/dev/null
        info "üìß Alerta enviado por email"
    fi
    
    # Alerta por Slack (se configurado)
    if [ "${ENABLE_SLACK_WEBHOOK:-false}" = "true" ] && [ -n "$ALERT_SLACK_WEBHOOK" ]; then
        local slack_payload="{\"text\":\"üö® ALERTA SEENTI: $alert_type - $message\"}"
        curl -X POST -H 'Content-type: application/json' --data "$slack_payload" "$ALERT_SLACK_WEBHOOK" 2>/dev/null
        info "üí¨ Alerta enviado para Slack"
    fi
}

# Fun√ß√£o para executar health check completo
run_health_check() {
    local check_time=$(date +'%Y-%m-%d %H:%M:%S')
    local failures=0
    local total_checks=0
    
    log "üè• Executando health check completo..."
    
    # 1. Frontend
    ((total_checks++))
    if check_frontend_health; then
        success "‚úÖ Frontend: Health check aprovado"
    else
        ((failures++))
        send_alert "FRONTEND_OFFLINE" "Frontend n√£o est√° respondendo"
    fi
    
    # 2. Backend
    ((total_checks++))
    if check_backend_health; then
        success "‚úÖ Backend: Health check aprovado"
    else
        ((failures++))
        send_alert "BACKEND_OFFLINE" "Backend n√£o est√° respondendo"
    fi
    
    # 3. Banco de dados
    ((total_checks++))
    if check_database_health; then
        success "‚úÖ MongoDB: Health check aprovado"
    else
        ((failures++))
        send_alert "DATABASE_OFFLINE" "MongoDB n√£o est√° respondendo"
    fi
    
    # 4. Recursos do sistema
    ((total_checks++))
    if check_system_resources; then
        success "‚úÖ Sistema: Health check aprovado"
    else
        ((failures++))
        send_alert "SYSTEM_RESOURCES" "Recursos do sistema em estado cr√≠tico"
    fi
    
    # 5. Funcionalidades cr√≠ticas
    ((total_checks++))
    if check_critical_functionality; then
        success "‚úÖ Funcionalidades: Health check aprovado"
    else
        ((failures++))
        send_alert "CRITICAL_FUNCTIONALITY" "Funcionalidades cr√≠ticas com problemas"
    fi
    
    # Resumo do health check
    local success_rate=$(( (total_checks - failures) * 100 / total_checks ))
    
    echo
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    üìä RESUMO DO HEALTH CHECK                 ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    
    echo "üéØ Resultados:"
    echo "   Total de verifica√ß√µes: $total_checks"
    echo "   ‚úÖ Aprovadas: $((total_checks - failures))"
    echo "   ‚ùå Reprovadas: $failures"
    echo "   üìä Taxa de Sucesso: $success_rate%"
    
    # Classificar status geral
    if [ $success_rate -ge 90 ]; then
        success "üèÜ Status Geral: EXCELENTE"
    elif [ $success_rate -ge 70 ]; then
        success "‚úÖ Status Geral: BOM"
    elif [ $success_rate -ge 50 ]; then
        warn "‚ö†Ô∏è  Status Geral: MODERADO"
    else
        error "‚ùå Status Geral: CR√çTICO"
    fi
    
    # Salvar m√©tricas
    echo "$check_time,$total_checks,$failures,$success_rate" >> "health_metrics.csv"
    
    return $failures
}

# Fun√ß√£o para monitoramento cont√≠nuo
continuous_monitoring() {
    log "üîÑ Iniciando monitoramento cont√≠nuo..."
    
    local consecutive_failures=0
    
    while true; do
        log "‚è∞ Executando health check programado..."
        
        if run_health_check; then
            consecutive_failures=0
            success "‚úÖ Health check bem-sucedido, aguardando pr√≥ximo ciclo..."
        else
            ((consecutive_failures++))
            warn "‚ö†Ô∏è  Health check falhou ($consecutive_failures/$MAX_FAILURES)"
            
            if [ $consecutive_failures -ge $MAX_FAILURES ]; then
                error "üö® CR√çTICO: $consecutive_failures falhas consecutivas!"
                send_alert "CRITICAL_FAILURE" "Sistema com $consecutive_failures falhas consecutivas"
                consecutive_failures=0  # Reset para evitar spam
            fi
        fi
        
        log "‚è≥ Aguardando $CHECK_INTERVAL segundos para pr√≥ximo health check..."
        sleep $CHECK_INTERVAL
    done
}

# Fun√ß√£o para mostrar status atual
show_status() {
    log "üìä Mostrando status atual do sistema..."
    
    echo
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    üìä STATUS DO SISTEMA                     ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo
    
    # Executar health check √∫nico
    run_health_check
    
    echo
    echo "üìà M√©tricas hist√≥ricas:"
    if [ -f "health_metrics.csv" ]; then
        echo "   üìä Total de registros: $(wc -l < health_metrics.csv)"
        echo "   üìÖ √öltima verifica√ß√£o: $(tail -1 health_metrics.csv | cut -d',' -f1)"
    else
        echo "   ‚ÑπÔ∏è  Nenhuma m√©trica hist√≥rica dispon√≠vel"
    fi
    
    echo
    echo "üîî Alertas:"
    if [ -f "$ALERT_LOG" ]; then
        echo "   üìù Total de alertas: $(wc -l < "$ALERT_LOG")"
        echo "   üö® √öltimo alerta: $(tail -1 "$ALERT_LOG" 2>/dev/null || echo "Nenhum")"
    else
        echo "   ‚ÑπÔ∏è  Nenhum alerta registrado"
    fi
}

# Fun√ß√£o principal
main() {
    log "üè• Iniciando Sistema de Monitoramento Seenti..."
    
    # Verificar argumentos
    case "${1:-}" in
        "status")
            load_config
            show_status
            ;;
        "continuous"|"")
            load_config
            continuous_monitoring
            ;;
        "config")
            create_default_config
            ;;
        *)
            echo "Uso: $0 [status|continuous|config]"
            echo "  status     - Mostrar status atual"
            echo "  continuous - Iniciar monitoramento cont√≠nuo (padr√£o)"
            echo "  config     - Criar configura√ß√£o padr√£o"
            exit 1
            ;;
    esac
}

# Executar fun√ß√£o principal
main "$@"
